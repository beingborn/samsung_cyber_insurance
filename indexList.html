<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>삼성화재 | 사이버보험 모바일 웹</title>
    </head>
    <link rel="stylesheet" href="./resources/css/default.css" />
    <link rel="stylesheet" href="./resources/css/index-list.css" />
    <body>
        <header class="index-header">
            <div class="index-header-inner">
                <div class="index-header-left">
                    <div class="page-title-wrap">
                        <h2 class="page-title">
                            <img src="./assets/images/logo/logo.svg" alt="삼성화재 사이버보험" />
                        </h2>
                        <strong>| 모바일 웹 프로토타입</strong>
                    </div>
                </div>
                <div class="index-header-right">
                    <div class="project-status">
                        <p>전체 페이지 : <span id="allPagesNum"></span></p>
                        <p>완료 페이지 : <span id="donePagesNum"></span></p>
                        <p>잔여 페이지 : <span id="remainPagesNum"></span></p>
                    </div>
                    <div class="project-search">
                        <input type="text" id="searchTerm" placeholder="화면명을 입력해주세요" maxlength="30" />
                    </div>
                </div>
            </div>
        </header>
        <div id="index-page-wrap">
            <div class="container">
                <div class="index-table-wrap">
                    <table class="index-table">
                        <caption>
                            프로젝트 현황 표
                        </caption>
                        <colgroup>
                            <col style="width: 12rem" />
                            <col style="width: 20rem" />
                            <col />
                            <col style="width: 8rem" />
                        </colgroup>
                        <thead>
                            <tr>
                                <th>카테고리</th>
                                <th>화면명</th>
                                <th>URL</th>
                                <th>완료 여부</th>
                            </tr>
                        </thead>
                        <tbody id="pagesTableBody">
                            <!-- 동적으로 생성됩니다 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </body>
    <script src="./resources/js/jquery-3.7.1.min.js"></script>
    <script>
        $(function () {
            let pagesData = [];
            let searchList = null;

            // JSON 데이터 로드 및 테이블 생성
            $.getJSON('./pages-data.json', function (data) {
                const tbody = $('#pagesTableBody');
                tbody.empty();

                data.categories.forEach(function (category) {
                    const pageCount = category.pages.length;
                    const basePath = './pages/' + category.id + '/';

                    category.pages.forEach(function (page, index) {
                        const tr = $('<tr></tr>');

                        // 첫 번째 행에만 카테고리 셀 추가 (rowspan)
                        if (index === 0) {
                            const categoryCell = $('<td></td>').attr('rowspan', pageCount);

                            if (category.type === 'prototype' && category.thumbnail) {
                                categoryCell.html('<div class="intro-thumbnail">' + '<span>' + category.name + '</span>' + '<img src="' + category.thumbnail + '" width="100" />' + '</div>');
                            } else {
                                categoryCell.text(category.name);
                            }

                            tr.append(categoryCell);
                        }

                        // 화면명
                        const titleCell = $('<td></td>')
                            .attr('data-col', 'title')
                            .text(page.title || '');
                        tr.append(titleCell);

                        // URL
                        const url = basePath + page.file;
                        const urlCell = $('<td></td>').html('<a href="' + url + '">' + url + '</a>');
                        tr.append(urlCell);

                        // 완료 여부
                        const isChecked = page.status === 'O' ? 'checked' : '';

                        const statusCell = $(`<td><input type="checkbox" ${isChecked}/></td>`).addClass('status txt-center');
                        tr.append(statusCell);

                        tbody.append(tr);
                    });
                });

                // 완료 후 초기화
                initializeTable();
            }).fail(function () {
                console.error('JSON 파일을 불러올 수 없습니다.');
                $('#pagesTableBody').html('<tr><td colspan="4" class="txt-center">데이터를 불러올 수 없습니다.</td></tr>');
            });

            $(document).on('change', '.status input[type="checkbox"]', function () {
                // 현재 체크 상태 확인
                const isChecked = $(this).is(':checked');

                console.log(isChecked);
            });

            // 테이블 초기화 및 이벤트 바인딩
            function initializeTable() {
                searchList = $('.index-table tbody tr:not(.disabled)');
                const pageLength = searchList.length;
                let donePageLength = 0;

                searchList.each(function () {
                    const $status = $(this).find('td.status input[type="checkbox"]');
                    const status = $status.prop('checked');

                    if (status) {
                        $status.addClass('done');
                        donePageLength++;
                    } else {
                        $status.addClass('not-done');
                    }
                });

                $('#allPagesNum').text(pageLength);
                $('#donePagesNum').text(donePageLength);
                $('#remainPagesNum').text(pageLength - donePageLength);

                $('.index-table tbody tr a').attr('target', '_blank');
            }

            // 검색 기능 (테이블 생성 후 바인딩)
            $('#searchTerm')
                .off('keyup')
                .on('keyup', function () {
                    if (!searchList) return;

                    const searchTerm = $(this).val().toLowerCase();

                    searchList.each(function () {
                        const title = $(this).find('td[data-col="title"]').text().toLowerCase();

                        if (title.includes(searchTerm)) {
                            $(this).show();
                        } else {
                            $(this).hide();
                        }
                    });
                });
        });
    </script>
</html>
